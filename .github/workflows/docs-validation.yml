name: Documentation Validation

# TEMPORARY LENIENT MODE (Until docs cleanup is complete)
# ========================================================
# Current validation approach:
#   ‚úÖ PASS: Build completes successfully (warnings logged but not blocking)
#   ‚úÖ PASS: Critical internal code/API links work
#   ‚ö†Ô∏è  WARN: Missing images, incomplete sections, orphaned pages (informational only)
#   ‚ùå FAIL: Build errors, broken critical internal links
#
# Once documentation cleanup is complete, restore strict validation:
#   - Uncomment the -W flag in build-docs step
#   - Remove image/asset exclusions in link checking
#   - Update PR comment to reflect strict mode

on:
  pull_request:
    paths:
      - 'docs/**'
      - 'specs/**'
      - '**.md'
      - '.specify/templates/feature-docs-checklist.md'
      - '.github/workflows/docs-validation.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'docs/**'
      - 'specs/**'
      - '**.md'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Poetry env
        uses: SamuelJennings/cached-poetry-action@v2.0
        with:
          python-version: '3.13'
          poetry-install-args: "--with docs"

      - name: Install geospatial dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            binutils libproj-dev gdal-bin libsqlite3-mod-spatialite

      - name: Build documentation (warnings logged, not blocking)
        id: build-docs
        run: |
          echo "Building documentation with warnings logged..."
          echo "Note: Warnings are informational only until docs cleanup is complete"
          poetry run sphinx-build -b html docs docs/_build 2>&1 | tee docs/_build/build.log || true

          # Count warnings for informational purposes
          WARNING_COUNT=$(grep -c "WARNING:" docs/_build/build.log || echo "0")
          echo "üìù Found $WARNING_COUNT documentation warnings (not blocking)"

          # Only fail on actual build errors, not warnings
          if poetry run sphinx-build -b html docs docs/_build > /dev/null 2>&1; then
            echo "‚úÖ Documentation build completed successfully"
            exit 0
          else
            echo "‚ùå Documentation build failed with errors"
            exit 1
          fi
        continue-on-error: false

      - name: Check internal links (lenient until docs cleanup)
        id: check-internal-links
        run: |
          echo "Checking links with sphinx-build -b linkcheck..."
          poetry run sphinx-build -b linkcheck docs docs/_build/linkcheck || true

          # Parse linkcheck output for critical internal link failures only
          if [ -f "docs/_build/linkcheck/output.txt" ]; then
            # Check for broken internal code/API references (critical)
            # Exclude image files and tutorial assets (non-critical until docs cleanup)
            BROKEN_CRITICAL=$(grep "\[broken\]" docs/_build/linkcheck/output.txt | grep -v "http" | grep -v "\.png" | grep -v "\.jpg" | grep -v "_static/" || true)

            if [ -n "$BROKEN_CRITICAL" ]; then
              echo "‚ùå Found broken critical internal links:"
              echo "$BROKEN_CRITICAL"
              echo ""
              echo "‚ö†Ô∏è  Note: Image file warnings are informational until docs cleanup is complete"
              exit 1
            else
              echo "‚úÖ All critical internal links are valid"
            fi

            # Report non-critical warnings
            BROKEN_IMAGES=$(grep "\[broken\]" docs/_build/linkcheck/output.txt | grep -E "\.png|\.jpg|_static/" || true)
            if [ -n "$BROKEN_IMAGES" ]; then
              echo ""
              echo "‚ö†Ô∏è  Non-critical warnings (images/assets - informational only):"
              echo "$BROKEN_IMAGES" | head -10
              if [ $(echo "$BROKEN_IMAGES" | wc -l) -gt 10 ]; then
                echo "... and more"
              fi
            fi

            # Check for broken external links (warnings only)
            BROKEN_EXTERNAL=$(grep "\[broken\]" docs/_build/linkcheck/output.txt | grep "http" || true)

            if [ -n "$BROKEN_EXTERNAL" ]; then
              echo ""
              echo "‚ö†Ô∏è Found broken external links (manual review recommended):"
              echo "$BROKEN_EXTERNAL" | head -5
              if [ $(echo "$BROKEN_EXTERNAL" | wc -l) -gt 5 ]; then
                echo "... and more"
              fi
            else
              echo "‚úÖ All external links are valid"
            fi
          else
            echo "‚ö†Ô∏è Link check output file not found at docs/_build/linkcheck/output.txt"
            ls -la docs/_build/linkcheck/ || echo "linkcheck directory not found"
          fi
        continue-on-error: false

      - name: Run internal link checker script
        id: internal-link-checker
        run: |
          echo "Running internal link checker script..."
          # Capture output but allow UTF-8 encoding errors
          poetry run python .github/scripts/check-internal-links.py 2>&1 || echo "Internal link checker completed with warnings"
        continue-on-error: true

      - name: Generate validation report
        id: generate-report
        if: always()
        run: |
          echo "Generating validation report..."
          poetry run python .github/scripts/generate-validation-report.py || echo "Report generation failed (non-blocking)"
        continue-on-error: true

      - name: Upload documentation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentation-build
          path: docs/_build/
          retention-days: 7

      - name: Comment PR with validation results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const body = `## üìù Documentation Validation Failed

            The documentation validation checks failed on **critical** errors. Please review and fix.

            **‚ö†Ô∏è  Lenient Mode Active**: Until docs cleanup is complete, only critical failures block PRs:
            - ‚úÖ **Informational**: Build warnings, missing images, incomplete sections
            - ‚ùå **Blocking**: Critical broken links to code/API references, build errors

            **What failed:**
            - Check the workflow logs above for specific critical errors
            - Focus on fixing broken internal links to code/documentation pages
            - Image and asset warnings can be addressed during docs cleanup

            **Need help?**
            - See [Documentation Standards](https://github.com/FAIR-DM/fairdm/blob/main/docs/contributing/documentation-standards.md)
            - Ask in discussions if you're unsure what needs fixing`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: body
            });
