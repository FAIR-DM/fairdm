name: Documentation Validation

on:
  pull_request:
    paths:
      - 'docs/**'
      - 'specs/**'
      - '**.md'
      - '.specify/templates/feature-docs-checklist.md'
      - '.github/workflows/docs-validation.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'docs/**'
      - 'specs/**'
      - '**.md'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Poetry env
        uses: SamuelJennings/cached-poetry-action@v2.0
        with:
          python-version: '3.13'

      - name: Install geospatial dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            binutils libproj-dev gdal-bin libsqlite3-mod-spatialite

      - name: Build documentation (warnings as errors)
        id: build-docs
        run: |
          echo "Building documentation with sphinx-build -W..."
          poetry run sphinx-build -W -b html docs docs/_build
        continue-on-error: false

      - name: Check internal links (hard failure)
        id: check-internal-links
        run: |
          echo "Checking links with sphinx-build -b linkcheck..."
          poetry run sphinx-build -b linkcheck docs docs/_build/linkcheck || true

          # Parse linkcheck output for internal link failures
          if [ -f "docs/_build/linkcheck/output.txt" ]; then
            # Check for broken internal links (non-HTTP URLs or relative paths)
            BROKEN_INTERNAL=$(grep "\\[broken\\]" docs/_build/linkcheck/output.txt | grep -v "http" || true)

            if [ -n "$BROKEN_INTERNAL" ]; then
              echo "‚ùå Found broken internal links:"
              echo "$BROKEN_INTERNAL"
              exit 1
            else
              echo "‚úÖ All internal links are valid"
            fi

            # Check for broken external links (warnings only)
            BROKEN_EXTERNAL=$(grep "\\[broken\\]" docs/_build/linkcheck/output.txt | grep "http" || true)

            if [ -n "$BROKEN_EXTERNAL" ]; then
              echo "‚ö†Ô∏è Found broken external links (manual review recommended):"
              echo "$BROKEN_EXTERNAL"
              # Don't fail on external links - these are informational
            else
              echo "‚úÖ All external links are valid"
            fi
          else
            echo "‚ö†Ô∏è Link check output file not found at docs/_build/linkcheck/output.txt"
            ls -la docs/_build/linkcheck/ || echo "linkcheck directory not found"
          fi
        continue-on-error: false

      - name: Run internal link checker script
        id: internal-link-checker
        run: |
          echo "Running internal link checker script..."
          # Capture output but allow UTF-8 encoding errors
          poetry run python .github/scripts/check-internal-links.py 2>&1 || echo "Internal link checker completed with warnings"
        continue-on-error: true

      - name: Generate validation report
        id: generate-report
        if: always()
        run: |
          echo "Generating validation report..."
          poetry run python .github/scripts/generate-validation-report.py || echo "Report generation failed (non-blocking)"
        continue-on-error: true

      - name: Upload documentation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentation-build
          path: docs/_build/
          retention-days: 7

      - name: Comment PR with validation results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const body = `## üìù Documentation Validation Failed

            The documentation validation checks failed. Please review the errors above and fix them before merging.

            **Common fixes:**
            - Fix broken internal links (must resolve correctly)
            - Ensure documentation builds without warnings
            - Complete feature documentation checklists
            - Review broken external links (warnings only, but should be fixed if possible)

            See the [Documentation Standards](https://github.com/FAIR-DM/fairdm/blob/main/docs/contributing/documentation-standards.md) for guidance.`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: body
            });
